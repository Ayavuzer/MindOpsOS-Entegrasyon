# E7.S1: AI Status Component

## Story Info

| Field | Value |
|-------|-------|
| Story ID | E7.S1 |
| Epic | E7: AI Frontend Integration |
| SP | 2 |
| Priority | P0 |
| Status | Done |

---

## User Story

**As a** user  
**I want** to see if AI service is active  
**So that** I understand the parsing quality

---

## Acceptance Criteria

- [x] `AIStatusBadge` component created at `components/ai/AIStatusBadge.tsx`
- [x] Shows "AI Active: gemini-2.0-flash" when available (green badge)
- [x] Shows "AI Offline" when unavailable (red badge)
- [x] Badge visible on dashboard (page.tsx)
- [x] Loading state with spinner while checking
- [x] Caches result in localStorage for 5 minutes
- [x] Handles network errors gracefully

---

## Technical Tasks

### Task 1: Create TypeScript Types

**File:** `types/ai.ts`

```typescript
export interface AIStatus {
    available: boolean;
    model: string | null;
}
```

### Task 2: Create API Client

**File:** `lib/api/ai.ts`

```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8080";

export async function getAIStatus(): Promise<AIStatus> {
    const res = await fetch(`${API_URL}/ai/status`);
    if (!res.ok) {
        return { available: false, model: null };
    }
    return res.json();
}
```

### Task 3: Create AIStatusBadge Component

**File:** `components/ai/AIStatusBadge.tsx`

```typescript
"use client";

import { useState, useEffect } from "react";
import { Brain, Loader2 } from "lucide-react";
import { getAIStatus, AIStatus } from "@/lib/api/ai";

const CACHE_KEY = "ai_status_cache";
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

export function AIStatusBadge() {
    const [status, setStatus] = useState<AIStatus | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const checkStatus = async () => {
            // Check cache first
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CACHE_TTL) {
                    setStatus(data);
                    setLoading(false);
                    return;
                }
            }

            // Fetch fresh status
            try {
                const data = await getAIStatus();
                setStatus(data);
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    data,
                    timestamp: Date.now(),
                }));
            } catch {
                setStatus({ available: false, model: null });
            } finally {
                setLoading(false);
            }
        };

        checkStatus();
    }, []);

    if (loading) {
        return (
            <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full">
                <Loader2 className="w-4 h-4 animate-spin text-slate-400" />
                <span className="text-xs text-slate-400">AI Loading...</span>
            </div>
        );
    }

    return (
        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full ${
            status?.available 
                ? "bg-emerald-500/10 border border-emerald-500/30" 
                : "bg-red-500/10 border border-red-500/30"
        }`}>
            <Brain className={`w-4 h-4 ${
                status?.available ? "text-emerald-400" : "text-red-400"
            }`} />
            {status?.available ? (
                <span className="text-xs text-emerald-400">
                    AI Active: {status.model}
                </span>
            ) : (
                <span className="text-xs text-red-400">AI Offline</span>
            )}
        </div>
    );
}
```

### Task 4: Add to Dashboard

**File:** `app/page.tsx`

```typescript
import { AIStatusBadge } from "@/components/ai/AIStatusBadge";

// Add in header section:
<div className="flex items-center gap-4">
    <AIStatusBadge />
    {/* existing content */}
</div>
```

---

## Testing Checklist

- [ ] Badge shows loading state on mount
- [ ] Badge shows "AI Active" when /ai/status returns available: true
- [ ] Badge shows "AI Offline" when /ai/status returns available: false
- [ ] Badge shows "AI Offline" on network error
- [ ] Cache is used for subsequent loads
- [ ] Cache expires after 5 minutes

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `types/ai.ts` | Create | TypeScript interfaces |
| `lib/api/ai.ts` | Create | API client |
| `components/ai/AIStatusBadge.tsx` | Create | Status badge component |
| `app/page.tsx` | Modify | Add badge to dashboard |

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Component renders correctly
- [x] No TypeScript errors
- [x] No console errors
- [x] Loading/error states work
- [ ] Code committed to git

---

## File List

| File | Action | Status |
|------|--------|--------|
| `src/types/ai.ts` | Created | ✅ |
| `src/lib/api/ai.ts` | Created | ✅ |
| `src/components/ai/AIStatusBadge.tsx` | Created | ✅ |
| `src/app/page.tsx` | Modified | ✅ |

---

## Dev Agent Record

### Agent Model Used

Antigravity + Marcus Chen (Full-Stack)

### Completion Notes

- Created TypeScript interfaces for AI features
- Created API client with getAIStatus, classifyEmail, extractStopSale
- Created AIStatusBadge with localStorage caching (5 min TTL)
- Added badge to dashboard header
- TypeScript check passed

### Completed At

2025-12-31T14:10:00+03:00
