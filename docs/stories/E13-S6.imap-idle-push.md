# Story: E13-S6 - IMAP IDLE Push Notifications

> **Epic:** E13 - Advanced Email Integration
> **Story Points:** 8
> **Priority:** P1
> **Status:** ✅ Done

---

## User Story

**As a** system  
**I want** real-time email notifications via IMAP IDLE  
**So that** reservations are processed instantly without polling delay

---

## Acceptance Criteria

- [x] **AC1:** IMAP IDLE connection manager
- [x] **AC2:** Real-time email detection
- [x] **AC3:** Graceful reconnection handling
- [x] **AC4:** Provider-agnostic abstraction
- [x] **AC5:** OAuth2 XOAUTH2 support

---

## Technical Notes

### IMAP IDLE Protocol

```
RFC 2177 - IMAP IDLE Extension

1. Client → Server: IDLE command
2. Server holds connection open
3. On new email: Server → Client: EXISTS notification
4. Client processes notification
5. Client → Server: DONE (restart IDLE)

Key Settings:
- idle_timeout: 29 min (RFC <30 min recommended)
- check_interval: 5 min refresh
```

### Architecture

```
IMAPIdleClient
├── Connection Management
│   ├── connect() → SSL/TLS connection
│   ├── authenticate() → Password or XOAUTH2
│   └── select_folder() → INBOX
├── IDLE Loop
│   ├── start_idle() → Background task
│   ├── _idle_loop() → Continuous loop
│   └── stop_idle() → Graceful shutdown
├── Event Handling
│   ├── _handle_new_email() → Search new UIDs
│   └── on_new_email callback
└── Reconnection
    ├── _reconnect() → Auto retry
    └── max_attempts: 10

IMAPConnectionManager
├── Connection Pool (per tenant:email_type)
├── Thread-safe Operations
└── Global Status Tracking

TenantIMAPService
├── start_tenant_idle() → Per-tenant config
├── _get_imap_config() → DB → IMAPConfig
└── OAuth Token Integration
```

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/email/idle/start` | POST | Start IMAP IDLE |
| `/api/email/idle/stop` | POST | Stop IMAP IDLE |
| `/api/email/idle/status/{type}` | GET | Get connection status |
| `/api/email/idle/status` | GET | Get all statuses |
| `/api/email/idle/admin/all` | GET | Admin: all connections |

### Connection States

| State | Description |
|-------|-------------|
| `disconnected` | No connection |
| `connecting` | Establishing connection |
| `connected` | TCP connected |
| `authenticating` | Auth in progress |
| `authenticated` | Login successful |
| `idle` | IDLE mode active |
| `error` | Error state |

---

## Tasks / Subtasks

- [x] Task 1: IMAPIdleClient Class (AC: #1-4)
  - [x] Connection management
  - [x] SSL/TLS support
  - [x] IDLE loop with asyncio
  - [x] Reconnection logic

- [x] Task 2: Auth Methods (AC: #4, #5)
  - [x] Password authentication
  - [x] OAuth2 XOAUTH2 authentication

- [x] Task 3: IMAPConnectionManager (AC: #1)
  - [x] Multi-tenant connection pool
  - [x] Thread-safe operations
  - [x] Status tracking

- [x] Task 4: TenantIMAPService (AC: #1-5)
  - [x] Tenant config loading
  - [x] OAuth token integration
  - [x] Email callback handling

- [x] Task 5: API Endpoints (AC: #1, #2)
  - [x] Start/Stop endpoints
  - [x] Status endpoints
  - [x] Admin endpoint

- [x] Task 6: Deployment (AC: #1-5)
  - [x] aioimaplib dependency
  - [x] Module rename (email → imap_idle)
  - [x] Docker build v1.2.1-imap-idle
  - [x] Kubernetes deployment

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/imap_idle/__init__.py` | Created | Module init |
| `apps/api/imap_idle/imap_idle.py` | Created | Core IMAP IDLE client |
| `apps/api/imap_idle/tenant_imap_service.py` | Created | Tenant service |
| `apps/api/imap_idle/routes.py` | Created | API endpoints |
| `apps/api/requirements.txt` | Modified | Added aioimaplib |
| `apps/api/main.py` | Modified | Service integration |
| `docs/stories/E13-S6.imap-idle-push.md` | Created | This story file |

---

## Dev Agent Record

### Agent Model Used

Antigravity + Marcus Chen (Full-Stack)

### Completion Notes

- Full IMAP IDLE implementation with aioimaplib
- OAuth2 XOAUTH2 support for Google/Microsoft
- Automatic reconnection with exponential backoff
- Module renamed from `email` to `imap_idle` (Python builtin conflict)
- Deployed as entegrasyon-api:v1.2.1-imap-idle
- Log shows "✅ IMAP IDLE service initialized"

### Bug Fix

- **Issue:** `email` module name conflicted with Python's builtin `email` module
- **Fix:** Renamed module to `imap_idle`

### Configuration

| Setting | Default | Description |
|---------|---------|-------------|
| `idle_timeout_seconds` | 1740 | 29 min (RFC <30 min) |
| `reconnect_delay_seconds` | 5 | Delay between retries |
| `max_reconnect_attempts` | 10 | Max retry count |

---

## Dependencies

### Depends On

- E13-S1: OAuth Data Model ✅
- E13-S2: Google OAuth Backend ✅
- E13-S4: Token Refresh ✅
- `aioimaplib` package

### Enables

- Real-time email processing
- Sub-second reservation detection
- E13-S7: Email Health Dashboard

---

## Next Steps

1. **Processing Integration:** Connect `on_new_email` to processing pipeline
2. **Frontend Toggle:** Add "Enable Real-time" switch in Settings
3. **Metrics:** Add connection metrics for monitoring
4. **Health Dashboard:** Visualize IDLE connection states

---

*Completed: 2025-12-29*
