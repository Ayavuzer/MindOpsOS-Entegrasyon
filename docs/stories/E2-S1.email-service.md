# Story: E2-S1 - IMAP Email Service

## Status: Done

> **Epic:** E2 - Email Processing  
> **Points:** 3  
> **Priority:** P0  
> **Created:** 2025-12-27  
> **Completed:** 2025-12-27

---

## User Story

**As a** system  
**I want** to connect to IMAP email servers and fetch emails  
**So that** I can process reservations and stop sale notifications automatically

---

## Acceptance Criteria

### AC1: IMAP Connection

- [x] Connect to IMAP server with SSL
- [x] Login with credentials
- [x] Select mailbox folder
- [x] Handle connection errors gracefully

### AC2: Email Fetching

- [x] Fetch unread emails
- [x] Support custom search criteria
- [x] Limit result count
- [x] Parse email headers (Subject, From, To, Date)
- [x] Extract body (text and HTML)
- [x] Extract attachments

### AC3: Email Operations

- [x] Mark as read
- [x] Mark with label/flag
- [x] Move to folder
- [x] List available folders

### AC4: Attachment Handling

- [x] Detect PDF attachments
- [x] Extract attachment content
- [x] Save attachments to disk

### AC5: Email Classification

- [x] Classify as reservation or stop sale
- [x] Support Turkish keywords
- [x] Handle unknown email types

### AC6: Batch Processing

- [x] EmailProcessor for high-level operations
- [x] Process booking emails with handler callback
- [x] Process stop sale emails with handler callback
- [x] Track success/failure statistics

---

## Tasks

- [x] Create EmailMessage Pydantic model
- [x] Create EmailAttachment model
- [x] Create EmailConnectionConfig
- [x] Implement EmailService class
- [x] Implement IMAP connection (SSL)
- [x] Implement email fetching (async)
- [x] Implement email parsing
- [x] Implement attachment extraction
- [x] Implement mark as read
- [x] Implement move to folder
- [x] Create EmailClassifier
- [x] Create EmailProcessor for batch ops
- [x] Create unit tests

---

## Technical Notes

### Async IMAP

IMAP is blocking I/O, so we use `asyncio.run_in_executor()`:

```python
loop = asyncio.get_event_loop()
_, message_numbers = await loop.run_in_executor(
    None,
    lambda: self.connection.search(None, "UNSEEN")
)
```

### Email Classification Keywords

**Reservation:**

- reservation, booking, confirmation, voucher
- rezervasyon, onay, juniper, travel, hotel

**Stop Sale:**

- stop sale, stopsale, stop-sale
- satış durdurma, closed, unavailable
- sold out, blackout

### PDF Detection

PDF detected by:

1. File extension: `.pdf` (case insensitive)
2. Content-Type: `application/pdf`

---

## Files Created

| File | Lines | Description |
|------|-------|-------------|
| `src/services/email_service.py` | ~550 | Full email service |
| `tests/test_email_service.py` | ~250 | Unit tests |

---

## Classes

| Class | Description |
|-------|-------------|
| `EmailMessage` | Parsed email with body and attachments |
| `EmailAttachment` | Attachment with content bytes |
| `EmailConnectionConfig` | Connection configuration |
| `EmailService` | IMAP operations |
| `EmailClassifier` | Classify email type |
| `EmailProcessor` | High-level batch processing |

---

## Definition of Done

- [x] All IMAP operations implemented
- [x] Attachment handling works
- [x] Classification logic complete
- [x] Unit tests pass
- [x] Documentation complete

---

*Story completed: 2025-12-27 23:30*
