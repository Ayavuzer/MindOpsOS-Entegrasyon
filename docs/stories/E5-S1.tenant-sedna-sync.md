# E5-S1: Tenant Sedna Sync

**Epic:** E5 - Sedna Integration  
**Story Points:** 5  
**Status:** Review  
**Sprint:** 2  

---

## User Story

**As a** tenant admin  
**I want** reservations and stop sales to sync to my Sedna account  
**So that** my agency system is automatically updated  

---

## Acceptance Criteria

1. ✅ **AC1:** Sedna service uses tenant's API credentials
2. ✅ **AC2:** Reservation sync to Sedna works per tenant
3. ✅ **AC3:** Stop Sale sync to Sedna works per tenant
4. ✅ **AC4:** Sync status tracked in database

---

## Tasks / Subtasks

- [x] Task 1: Create tenant-aware Sedna service (AC: #1-2)
- [x] Task 2: Add stop sale sync (AC: #3)
- [x] Task 3: Create sync endpoints (AC: #4)

---

## File List

### Backend (apps/api/sedna/)

- `__init__.py` - Created
- `service.py` - Created (TenantSednaService)
- `routes.py` - Created (sync endpoints)

### Modified

- `apps/api/main.py` - Added sedna router and service

---

## API Endpoints

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/api/sedna/sync/reservation/{email_id}` | POST | ✓ | Sync single reservation |
| `/api/sedna/sync/stop-sale/{stop_sale_id}` | POST | ✓ | Sync single stop sale |
| `/api/sedna/sync/pending` | POST | ✓ | Sync all pending items |

---

## Response Models

### Single Sync

```json
{
  "success": true,
  "message": "Synced successfully",
  "sedna_rec_id": 12345,
  "details": {}
}
```

### Sync Pending

```json
{
  "reservations_synced": 5,
  "reservations_failed": 1,
  "stop_sales_synced": 3,
  "stop_sales_failed": 0,
  "errors": ["Reservation 42: Hotel not found"]
}
```

---

## Technical Notes

- Gets decrypted Sedna credentials from TenantSettingsService
- Hotel lookup by name (partial match)
- Updates sedna_synced and sedna_rec_id on success
- Processes up to 50 pending items per sync call

---

## Dev Agent Record

### Agent Model Used

Antigravity

### Completion Notes

- TenantSednaService created with sync_reservation, sync_stop_sale, sync_pending
- Hotel ID lookup via GetHotels API
- Uses tenant's operator_id from settings
- All sync operations are tenant-isolated
- Error details returned for failed syncs
