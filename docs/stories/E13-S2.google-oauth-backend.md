# Story: E13-S2 - Google OAuth Flow - Backend

> **Epic:** E13 - Advanced Email Integration
> **Story Points:** 8
> **Priority:** P1
> **Status:** ✅ Done

---

## User Story

**As a** tenant admin  
**I want** to connect Gmail via OAuth  
**So that** I don't need to use app passwords

---

## Acceptance Criteria

- [x] **AC1:** `/api/oauth/google/authorize` endpoint - generates auth URL
- [x] **AC2:** `/api/oauth/google/callback` endpoint - handles callback
- [x] **AC3:** Token storage after successful auth - encrypted in DB
- [x] **AC4:** Error handling for denied access - redirects with error

---

## Technical Notes

### OAuth Flow

```
1. Frontend calls POST /api/oauth/google/authorize
   → Returns authorization_url with state parameter

2. User redirected to Google consent screen
   → User approves or denies

3. Google redirects to /api/oauth/google/callback
   → With code and state parameters

4. Backend exchanges code for tokens
   → Stores encrypted tokens in DB
   → Redirects to /settings with success/error
```

### API Endpoints

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/api/oauth/google/authorize` | POST | JWT | Get auth URL |
| `/api/oauth/google/callback` | GET | None | Handle callback |
| `/api/oauth/google/disconnect` | POST | JWT | Remove OAuth |
| `/api/oauth/refresh` | POST | JWT | Manual refresh |
| `/api/oauth/status` | GET | JWT | Check config status |

### Security Features

- CSRF protection via state parameter (JWT encoded)
- Token encryption with Fernet
- 10-minute state expiry
- Scope minimization (gmail.readonly, gmail.modify)

---

## Tasks / Subtasks

- [x] Task 1: Google OAuth Configuration (AC: #1)
  - [x] GoogleOAuthConfig class
  - [x] Environment variables setup
  - [x] State parameter generation

- [x] Task 2: OAuth Service (AC: #2, #3)
  - [x] Token exchange logic
  - [x] User email retrieval
  - [x] Encrypted token storage
  - [x] Token refresh mechanism

- [x] Task 3: OAuth Routes (AC: #1, #2, #4)
  - [x] Authorization endpoint
  - [x] Callback endpoint
  - [x] Disconnect endpoint
  - [x] Status endpoint

- [x] Task 4: Integration (AC: #1-4)
  - [x] Router registration in main.py
  - [x] Lazy import for circular deps
  - [x] Pydantic V2 compatibility fixes

- [x] Task 5: Deployment (AC: #1-4)
  - [x] Docker build v1.0.8
  - [x] Kubernetes deployment
  - [x] Endpoint verification

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/oauth/google.py` | Created | Google OAuth configuration |
| `apps/api/oauth/service.py` | Created | OAuth service with token management |
| `apps/api/oauth/routes.py` | Created | OAuth API endpoints |
| `apps/api/oauth/__init__.py` | Modified | Lazy import for circular deps |
| `apps/api/oauth/models.py` | Modified | Pydantic V2 pattern fixes |
| `apps/api/tenant/models.py` | Modified | Local enums to avoid circular import |
| `apps/api/main.py` | Modified | OAuth router registration |
| `apps/api/requirements.txt` | Modified | Added PyJWT |
| `docs/stories/E13-S2.google-oauth-backend.md` | Created | This story file |

---

## Dev Agent Record

### Agent Model Used

Antigravity + Marcus Chen (Full-Stack)

### Completion Notes

- All OAuth endpoints deployed and verified
- Pydantic V2 compatibility: `regex` → `pattern`
- Circular import resolved via lazy router import
- Deployed as entegrasyon-api:v1.0.8
- OAuth status endpoint available at `/api/oauth/status`

### Issues Encountered

1. **Pydantic V2 Breaking Change:** `regex` parameter removed, replaced with `pattern`
2. **Circular Import:** oauth.routes → auth → tenant → oauth.models
   - Solution: Defined enums locally in tenant/models.py
   - Used lazy import for oauth_router in main.py
3. **Import Path:** `get_current_user` is in `auth` module, not `auth.service`

### Environment Variables Required

```bash
GOOGLE_OAUTH_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_OAUTH_CLIENT_SECRET=xxx
GOOGLE_OAUTH_REDIRECT_URI=https://entegrasyon.mindops.net/api/oauth/google/callback
```

---

## Dependencies

### Depends On

- E13-S1: OAuth Data Model ✅

### Enables

- E13-S3: Google OAuth Frontend
- E13-S4: Token Refresh Mechanism

---

*Completed: 2025-12-28*
