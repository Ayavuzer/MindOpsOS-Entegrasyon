# E4-S1: Tenant POP3 Email Fetch

**Epic:** E4 - Tenant Email Processing  
**Story Points:** 5  
**Status:** Review  
**Sprint:** 2  

---

## User Story

**As a** tenant admin  
**I want** the system to fetch emails from my configured POP3 server  
**So that** Juniper reservation emails are automatically processed  

---

## Acceptance Criteria

1. ✅ **AC1:** POP3 service uses tenant credentials from tenant_settings
2. ✅ **AC2:** Fetched emails saved with tenant_id
3. ✅ **AC3:** Manual fetch endpoint works per tenant
4. ✅ **AC4:** Fetch status returned to UI

---

## Tasks / Subtasks

- [x] Task 1: Create tenant-aware POP3 service (AC: #1-2)
- [x] Task 2: Create fetch endpoint (AC: #3-4)
- [ ] Task 3: Update UI with fetch button (future enhancement)

---

## Technical Notes

- Uses encrypted credentials from tenant_settings
- Each tenant has separate booking_email and stopsale_email configs
- Emails saved to emails table with tenant_id
- Email classification (booking/stopsale/unknown) based on subject and content

---

## File List

### Backend (apps/api/emailfetch/)

- `__init__.py` - Created
- `service.py` - Created (TenantEmailService)
- `routes.py` - Created (fetch endpoints)

### Modified

- `apps/api/main.py` - Added emailfetch router and service

---

## API Endpoints

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/api/email/fetch?email_type=booking\|stopsale` | POST | ✓ | Fetch emails from specified mailbox |
| `/api/email/fetch/all` | POST | ✓ | Fetch from both mailboxes |

---

## Response Model

```json
{
  "success": true,
  "message": "Fetched 5 new emails, 2 skipped",
  "emails_fetched": 7,
  "emails_new": 5,
  "emails_skipped": 2,
  "errors": []
}
```

---

## Dev Agent Record

### Agent Model Used

Antigravity

### Completion Notes

- Created TenantEmailService with fetch_emails method
- Gets decrypted credentials from TenantSettingsService
- POP3 SSL connection with disabled cert verification (for legacy servers)
- Email parsing and classification
- Duplicate detection via message_id + tenant_id
- PDF attachment detection and storage
- All emails tagged with tenant_id
