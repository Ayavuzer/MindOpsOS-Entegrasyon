# E1-S1: Multi-Tenant Database Schema

**Epic:** E1 - User Authentication  
**Story Points:** 3  
**Status:** Review  
**Sprint:** 1  

---

## User Story

**As a** platform developer  
**I want** tenant and user tables in the database  
**So that** multiple agencies can have isolated data  

---

## Acceptance Criteria

1. ✅ **AC1:** `tenants` tablosu oluşturulmuş (id, name, slug, is_active, timestamps)
2. ✅ **AC2:** `users` tablosu oluşturulmuş (id, tenant_id, email, password_hash, role, timestamps)
3. ✅ **AC3:** `tenant_settings` tablosu oluşturulmuş (email configs, sedna configs, encrypted)
4. ✅ **AC4:** `sessions` tablosu oluşturulmuş (JWT blacklist)
5. ✅ **AC5:** Mevcut tablolara `tenant_id` foreign key eklenmiş
6. ✅ **AC6:** Migration scriptleri hazır
7. ✅ **AC7:** Schema başarıyla uygulanmış

---

## Tasks / Subtasks

- [x] Task 1: Migration dosyaları oluştur (AC: #6)
  - [x] 001_create_tenants.sql
  - [x] 002_create_users.sql
  - [x] 003_create_tenant_settings.sql
  - [x] 004_create_sessions.sql
  - [x] 005_add_tenant_id_to_existing.sql
- [x] Task 2: Schema'yı PostgreSQL'e uygula (AC: #1-5, #7)
- [x] Task 3: Test verisi oluştur (default tenant + admin user)

---

## Technical Notes

- Database: `mindops_entegrasyon` (PostgreSQL 17)
- Connection: `aria:aria_secure_2024@localhost:5432`
- Encryption için Fernet kullanılacak
- Password hashing için bcrypt

---

## File List

- `migrations/001_create_tenants.sql` - Created
- `migrations/002_create_users.sql` - Created
- `migrations/003_create_tenant_settings.sql` - Created
- `migrations/004_create_sessions.sql` - Created
- `migrations/005_add_tenant_id_to_existing.sql` - Created

---

## Test Data Created

**Tenant:**

| id | name | slug | is_active |
|----|------|------|-----------|
| 1 | Point Holiday | point-holiday | true |

**User:**

| id | email | name | role | password |
|----|-------|------|------|----------|
| 1 | <admin@pointholiday.com> | Admin User | superadmin | Admin123! |

---

## Dev Agent Record

### Agent Model Used

Antigravity

### Completion Notes

- All 5 migration scripts created and executed successfully
- Tables created: tenants, users, tenant_settings, sessions
- tenant_id added to: emails, reservations, stop_sales, processing_logs
- Default tenant (Point Holiday) created
- Superadmin user created with bcrypt-hashed password
- All indexes and constraints in place
- Trigger for updated_at on all relevant tables
