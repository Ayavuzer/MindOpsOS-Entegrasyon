# Story: E1-S3 - Sedna API Client

## Status: Done

> **Epic:** E1 - Foundation & Setup  
> **Points:** 3  
> **Priority:** P0  
> **Created:** 2025-12-27  
> **Completed:** 2025-12-27

---

## User Story

**As a** developer  
**I want** a complete async Sedna API client  
**So that** I can interact with Sedna Agency system for reservations and stop sales

---

## Acceptance Criteria

### AC1: Authentication

- [x] Login endpoint implementation
- [x] OperatorId extraction from response
- [x] Session management with context manager
- [x] Error handling for auth failures

### AC2: Master Data Endpoints

- [x] GetHotelList - Otel listesi
- [x] GetHotelRoomTypelistAll - Oda tipleri
- [x] GetCountrys - Ülke listesi
- [x] GetOperators - Operatör listesi
- [x] GetTransferTypeForIntegration - Transfer tipleri

### AC3: Reservation Endpoints

- [x] InsertReservation - Rezervasyon oluşturma
- [x] GetReservations - Rezervasyon listesi
- [x] GetReservationByVoucher - Voucher ile sorgulama
- [x] CancelReservationBySourcId - İptal işlemi

### AC4: Stop Sale Endpoints

- [x] GetStopSaleList - Stop sale listesi
- [x] GetStopSaleListWithUpdateDate - Güncelleme tarihli liste

### AC5: Supporting Features

- [x] Pydantic models for all request/response types
- [x] Error handling with custom exceptions
- [x] Logging with structlog
- [x] Type hints throughout
- [x] Unit tests

---

## Tasks

- [x] Create sedna_client.py with SednaClient class
- [x] Implement authentication (login)
- [x] Implement master data endpoints
- [x] Implement reservation endpoints
- [x] Implement stop sale endpoints
- [x] Create Pydantic models (request/response)
- [x] Add error handling (SednaApiError, SednaAuthError, SednaValidationError)
- [x] Create mapping_service.py for ID mapping
- [x] Create unit tests (test_sedna_client.py)

---

## Technical Notes

### API Base URL

```
http://test.kodsedna.com/SednaAgencyb2bApi/api
```

### Typo in API Path

⚠️ API uses `Integratiion` (double 'i') - handled in client.

### Authentication

- Query param based: `?username=xxx&password=xxx`
- Returns OperatorId in `RecId` field

### InsertReservation

- Body must be **array** format: `[{reservation}]`
- VoucherNo passed as query param

### Customer Title Values

| Title | Meaning |
|-------|---------|
| Mr | Adult male |
| Mrs | Adult female |
| Grp | Group |
| Chd | Child |
| Inf | Infant |

---

## Files Created

| File | Description |
|------|-------------|
| `src/services/sedna_client.py` | Main API client (~600 lines) |
| `src/services/mapping_service.py` | ID mapping service (~300 lines) |
| `tests/test_sedna_client.py` | Unit tests (~250 lines) |
| `tests/conftest.py` | Pytest configuration |

---

## Definition of Done

- [x] All endpoints implemented
- [x] Pydantic models for type safety
- [x] Error handling complete
- [x] Unit tests pass
- [x] Code documented

---

*Story completed: 2025-12-27 23:20*
