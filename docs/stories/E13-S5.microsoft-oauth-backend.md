# Story: E13-S5 - Microsoft OAuth Backend

> **Epic:** E13 - Advanced Email Integration
> **Story Points:** 3
> **Priority:** P2
> **Status:** ✅ Done

---

## User Story

**As a** tenant admin  
**I want** to connect Outlook/Microsoft 365 via OAuth  
**So that** I can use enterprise email accounts

---

## Acceptance Criteria

- [x] **AC1:** Microsoft OAuth configuration module
- [x] **AC2:** Token exchange flow
- [x] **AC3:** API endpoints for authorize, callback, disconnect
- [x] **AC4:** Token refresh support

---

## Technical Notes

### Microsoft OAuth Flow

```
1. User clicks "Connect with Microsoft" (future frontend)
2. POST /api/oauth/microsoft/authorize
3. Redirect to login.microsoftonline.com
4. User consents
5. Microsoft redirects to /api/oauth/microsoft/callback
6. Exchange code for tokens
7. Get user email from Graph API
8. Store encrypted tokens in DB
```

### API Endpoints

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/api/oauth/microsoft/authorize` | POST | JWT | Get authorization URL |
| `/api/oauth/microsoft/callback` | GET | None | Handle OAuth callback |
| `/api/oauth/microsoft/disconnect` | POST | JWT | Disconnect & revert to password |

### OAuth Scopes

```python
MICROSOFT_OAUTH_SCOPES = [
    "openid",
    "profile",
    "email",
    "offline_access",  # Required for refresh tokens
    "https://outlook.office.com/IMAP.AccessAsUser.All",
    "https://outlook.office.com/SMTP.Send",
]
```

### Environment Variables

```bash
MICROSOFT_OAUTH_CLIENT_ID=xxx
MICROSOFT_OAUTH_CLIENT_SECRET=xxx
MICROSOFT_OAUTH_TENANT_ID=common  # 'common' for multi-tenant apps
MICROSOFT_OAUTH_REDIRECT_URI=https://entegrasyon.mindops.net/api/oauth/microsoft/callback
```

### Tenant Options

| Tenant ID Value | Description |
|-----------------|-------------|
| `common` | Any Microsoft account (personal + work) |
| `organizations` | Any Azure AD account |
| `consumers` | Microsoft personal accounts only |
| `{tenant-id}` | Specific organization only |

---

## Tasks / Subtasks

- [x] Task 1: Microsoft OAuth Configuration (AC: #1)
  - [x] `microsoft.py` module with config class
  - [x] State generation with JWT
  - [x] URL builder function

- [x] Task 2: Service Methods (AC: #2, #4)
  - [x] `handle_microsoft_callback()` method
  - [x] `_exchange_microsoft_code()` token exchange
  - [x] `_get_microsoft_user_email()` Graph API call
  - [x] `refresh_microsoft_token()` refresh logic

- [x] Task 3: API Routes (AC: #3)
  - [x] POST `/microsoft/authorize`
  - [x] GET `/microsoft/callback`
  - [x] POST `/microsoft/disconnect`

- [x] Task 4: Status Endpoint Update (AC: #1)
  - [x] Include Microsoft in `/status` response

- [x] Task 5: Deployment (AC: #1-4)
  - [x] Docker build v1.1.0
  - [x] Kubernetes deployment

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/oauth/microsoft.py` | Created | Microsoft OAuth config & utilities |
| `apps/api/oauth/service.py` | Modified | Added Microsoft methods |
| `apps/api/oauth/routes.py` | Modified | Added Microsoft endpoints |
| `docs/stories/E13-S5.microsoft-oauth-backend.md` | Created | This story file |

---

## Dev Agent Record

### Agent Model Used

Antigravity + Marcus Chen (Full-Stack)

### Completion Notes

- Follows same pattern as Google OAuth
- Uses Microsoft Graph API for user info
- Supports rotating refresh tokens (Microsoft may issue new refresh token on refresh)
- Multi-tenant support with configurable tenant_id
- Deployed as entegrasyon-api:v1.1.0

### Design Decisions

1. **Tenant ID:** Defaulting to 'common' for maximum flexibility
2. **Scopes:** Including IMAP and SMTP access for email operations
3. **Refresh Tokens:** Handling Microsoft's rotating refresh token behavior
4. **Graph API:** Using `/v1.0/me` endpoint with fallback to `userPrincipalName`

---

## Dependencies

### Depends On

- E13-S1: OAuth Data Model ✅
- E13-S2: Google OAuth Backend ✅ (shared infrastructure)

### Enables

- Full Microsoft 365 email integration
- Enterprise email support

---

## Next Steps

1. Frontend: Add "Connect with Microsoft" button (similar to Google)
2. Azure AD App Registration required for production use
3. Consider adding Graph API permissions for calendar/contacts if needed

---

*Completed: 2025-12-28*
