# Story: E2-S3 / E3-S1 - PDF & Email Parsers

## Status: Done

> **Epic:** E2 - Email Processing / E3 - Reservation Integration  
> **Points:** 5 (Combined)  
> **Priority:** P0  
> **Created:** 2025-12-27  
> **Completed:** 2025-12-27

---

## User Story

**As a** system  
**I want** to parse PDF reservation confirmations and email bodies  
**So that** I can extract reservation and stop sale data automatically

---

## Acceptance Criteria

### AC1: PDF Parsing

- [x] Open PDF files using PyMuPDF
- [x] Extract text from all pages
- [x] Support parsing from file path or bytes
- [x] Handle PDF errors gracefully

### AC2: Reservation Data Extraction

- [x] Extract voucher/booking reference
- [x] Extract hotel name
- [x] Extract check-in and check-out dates
- [x] Extract room type and board type
- [x] Extract guest count (adults/children)
- [x] Extract guest names
- [x] Extract total price and currency

### AC3: Stop Sale Email Parsing

- [x] Extract hotel name from email body
- [x] Extract date range (from/to)
- [x] Extract room types (or "all")
- [x] Extract board types (or "all")
- [x] Detect open sale vs stop sale
- [x] Extract reason (optional)

### AC4: Multi-Format Support

- [x] Support DD/MM/YYYY date format
- [x] Support DD.MM.YYYY date format
- [x] Support ISO date format
- [x] Support European price format (1.234,56)
- [x] Support Turkish keywords (rezervasyon, otel, satış durdurma)

### AC5: Normalization

- [x] Normalize board types to codes (AI, FB, HB, BB, RO)
- [x] Normalize room types to codes (DBL, SGL, TRP, etc.)
- [x] Normalize currencies to ISO codes

---

## Tasks

- [x] Create pdf_parser.py with JuniperPdfParser
- [x] Implement text extraction (PyMuPDF)
- [x] Implement pattern-based field extraction
- [x] Implement date parsing with multiple formats
- [x] Implement price parsing with European format
- [x] Implement guest extraction
- [x] Create email_parser.py with StopSaleEmailParser
- [x] Implement stop sale extraction
- [x] Implement Turkish keyword support
- [x] Create unit tests

---

## Technical Notes

### Pattern Matching

Using regex patterns for flexible extraction:

```python
PATTERNS = {
    "voucher_no": [
        r"(?:Voucher|Booking|Reference)[:\s]+([A-Z0-9]{4,20})",
        r"(?:Rezervasyon|Onay)[:\s]+([A-Z0-9]{4,20})",
    ],
    ...
}
```

### Date Formats Supported

| Format | Example | Region |
|--------|---------|--------|
| DD/MM/YYYY | 15/01/2025 | EU |
| DD.MM.YYYY | 15.01.2025 | TR |
| YYYY-MM-DD | 2025-01-15 | ISO |
| DD/MM/YY | 15/01/25 | Short |

### Price Formats

| Format | Value | Parsed |
|--------|-------|--------|
| 1234.56 | US | 1234.56 |
| 1.234,56 | EU | 1234.56 |
| € 1,234.56 | With symbol | 1234.56 |

### Board Type Mapping

| Input | Output |
|-------|--------|
| All Inclusive | AI |
| Full Board | FB |
| Half Board | HB |
| Bed & Breakfast | BB |
| Room Only | RO |

---

## Files Created

| File | Lines | Description |
|------|-------|-------------|
| `src/parsers/pdf_parser.py` | ~450 | Juniper PDF parser |
| `src/parsers/email_parser.py` | ~280 | Stop sale email parser |
| `tests/test_parsers.py` | ~280 | Unit tests |

---

## Classes

| Class | Description |
|-------|-------------|
| `JuniperPdfParser` | Parse reservation PDFs |
| `StopSaleEmailParser` | Parse stop sale emails |
| `ExtractionPattern` | Pattern configuration |

---

## Definition of Done

- [x] PDF parsing works with multiple formats
- [x] Stop sale parsing handles various email formats
- [x] Turkish keywords supported
- [x] Unit tests pass
- [x] Error handling complete

---

*Story completed: 2025-12-27 23:35*
