# Story: E13-S4 - OAuth Token Refresh Mechanism

> **Epic:** E13 - Advanced Email Integration
> **Story Points:** 3
> **Priority:** P2
> **Status:** ✅ Done

---

## User Story

**As a** system  
**I want** automatic token refresh  
**So that** email connections don't break when tokens expire

---

## Acceptance Criteria

- [x] **AC1:** Background token refresh before expiry
- [x] **AC2:** Graceful handling of refresh failures
- [x] **AC3:** Token expiry monitoring endpoint

---

## Technical Notes

### Background Job Architecture

```
TokenRefreshJob
├── check_interval_seconds = 300 (5 min)
├── refresh_before_expiry_minutes = 10
├── _run_loop() → Continuous async loop
├── _check_and_refresh_tokens() → DB query for expiring tokens
└── _refresh_token_safe() → Individual token refresh with error handling
```

### Token Lifecycle

```
1. Token Created (OAuth callback)
   ├── Expiry: +3600 seconds (1 hour)
   └── Stored encrypted in DB

2. Token Monitored (Every 5 min)
   └── If expiry < NOW + 10 min → Refresh

3. Token Refreshed
   ├── POST to https://oauth2.googleapis.com/token
   ├── New access_token received
   ├── New expiry calculated
   └── Stored encrypted in DB

4. Token Expired (Fallback)
   └── Next email operation triggers refresh
```

### API Endpoints

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/api/oauth/token-refresh/status` | GET | JWT | Get job status & stats |

### Response Format

```json
{
  "running": true,
  "check_interval_seconds": 300,
  "refresh_before_expiry_minutes": 10,
  "stats": {
    "booking_oauth_count": 2,
    "stopsale_oauth_count": 1,
    "booking_expiring_soon": 0,
    "stopsale_expiring_soon": 0,
    "booking_expired": 0,
    "stopsale_expired": 0
  }
}
```

---

## Tasks / Subtasks

- [x] Task 1: TokenRefreshJob Class (AC: #1, #2)
  - [x] Async background job pattern
  - [x] Configurable check interval
  - [x] Configurable refresh threshold
  - [x] Safe error handling per token

- [x] Task 2: Token Expiry Query (AC: #1)
  - [x] SQL query for tokens expiring soon
  - [x] Check both booking and stopsale

- [x] Task 3: Status Endpoint (AC: #3)
  - [x] GET /api/oauth/token-refresh/status
  - [x] Token counts and expiry stats

- [x] Task 4: Lifespan Integration (AC: #1)
  - [x] Start job on app startup
  - [x] Stop job on app shutdown
  - [x] Store pool in app.state

- [x] Task 5: Deployment (AC: #1-3)
  - [x] Docker build v1.0.9
  - [x] Kubernetes deployment
  - [x] Log verification

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/oauth/token_refresh_job.py` | Created | Background job for token refresh |
| `apps/api/oauth/routes.py` | Modified | Added status endpoint |
| `apps/api/main.py` | Modified | Job initialization in lifespan |
| `docs/stories/E13-S4.token-refresh-mechanism.md` | Created | This story file |

---

## Dev Agent Record

### Agent Model Used

Antigravity + Marcus Chen (Full-Stack)

### Completion Notes

- Background job runs every 5 minutes
- Refreshes tokens 10 minutes before expiry
- Graceful error handling per tenant/email_type
- Status endpoint provides monitoring data
- Deployed as entegrasyon-api:v1.0.9
- Log shows "✅ Token refresh job started"

### Configuration

| Setting | Value | Description |
|---------|-------|-------------|
| `check_interval_seconds` | 300 | Check every 5 minutes |
| `refresh_before_expiry_minutes` | 10 | Refresh 10 min before expiry |

---

## Dependencies

### Depends On

- E13-S2: Google OAuth Backend ✅ (refresh_google_token method)

### Enables

- Reliable long-running OAuth connections
- No manual token refresh needed

---

*Completed: 2025-12-28*
