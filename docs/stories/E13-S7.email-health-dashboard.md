# Story: E13-S7 - Email Health Dashboard

> **Epic:** E13 - Advanced Email Integration
> **Story Points:** 5
> **Priority:** P2
> **Status:** ‚úÖ Done

---

## User Story

**As a** tenant admin  
**I want** to see email service health status  
**So that** I can monitor and troubleshoot email connections

---

## Acceptance Criteria

- [x] **AC1:** IMAP IDLE connection status display
- [x] **AC2:** OAuth token status and expiry
- [x] **AC3:** Email processing statistics
- [x] **AC4:** Health score calculation
- [x] **AC5:** Dashboard widget component

---

## Technical Notes

### Health Score Calculation

```python
health_score = 100

# OAuth penalties
if auth_method == "oauth2":
    if not connected: score -= 50
    elif expired: score -= 40
    elif expiring_soon: score -= 20

# IMAP IDLE penalty
if not imap_active: score -= 10

# Error penalty (max -30)
score -= min(30, errors_today * 5)

health_score = max(0, score)
```

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/email/idle/health` | GET | Full health status |
| `/api/email/idle/health/summary` | GET | Dashboard summary |

### Response Model

```typescript
interface TenantEmailHealth {
  tenant_id: number;
  checked_at: Date;
  booking: EmailHealth;
  stopsale: EmailHealth;
  overall_health: "healthy" | "warning" | "critical";
}

interface EmailHealth {
  email_type: string;
  configured: boolean;
  email_address: string;
  auth_method: "password" | "oauth2";
  oauth: OAuthHealth;
  imap_idle: IMAPIdleHealth;
  health_score: number;  // 0-100
}
```

### Health Thresholds

| Score | Status | Icon |
|-------|--------|------|
| 80-100 | healthy | ‚úÖ |
| 50-79 | warning | ‚ö†Ô∏è |
| 0-49 | critical | ‚ùå |

---

## Tasks / Subtasks

- [x] Task 1: Health Service Backend (AC: #1-4)
  - [x] EmailHealthService class
  - [x] OAuth status tracking
  - [x] IMAP IDLE status
  - [x] Health score calculation

- [x] Task 2: API Endpoints (AC: #1-4)
  - [x] GET /health endpoint
  - [x] GET /health/summary endpoint

- [x] Task 3: Frontend Component (AC: #5)
  - [x] EmailHealthDashboard component
  - [x] EmailHealthCard sub-component
  - [x] Auto-refresh (30s)
  - [x] Error handling

- [x] Task 4: Settings Integration (AC: #5)
  - [x] Add dashboard to Settings page
  - [x] Position before email forms

- [x] Task 5: Deployment (AC: #1-5)
  - [x] API build v1.3.0-health
  - [x] Web build v1.1.0-health
  - [x] Kubernetes deployment

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/imap_idle/health_service.py` | Created | Health monitoring service |
| `apps/api/imap_idle/routes.py` | Modified | Health endpoints |
| `apps/api/main.py` | Modified | Service init |
| `apps/web/src/components/EmailHealthDashboard.tsx` | Created | Dashboard component |
| `apps/web/src/app/settings/page.tsx` | Modified | Dashboard integration |
| `docs/stories/E13-S7.email-health-dashboard.md` | Created | This story file |

---

## Dev Agent Record

### Agent Model Used

Antigravity + Marcus Chen (Full-Stack) + Aria Vega (Design)

### Completion Notes

- Health service with comprehensive scoring
- Dashboard auto-refreshes every 30 seconds
- OAuth expiry tracking with warnings
- IMAP IDLE state visualization
- Processing statistics (emails/errors today)
- Responsive grid layout for booking/stopsale cards

### Docker Images

- API: `ghcr.io/ayavuzer/entegrasyon-api:v1.3.0-health`
- Web: `ghcr.io/ayavuzer/entegrasyon-web:v1.1.0-health`

---

## Dependencies

### Depends On

- E13-S4: Token Refresh ‚úÖ
- E13-S6: IMAP IDLE ‚úÖ

### Enables

- Production monitoring
- Proactive issue detection
- SLA compliance tracking

---

## üéâ E13 Epic Complete

All 7 stories complete:

| Story | SP | Status |
|-------|---:|--------|
| E13-S1 OAuth Data Model | 5 | ‚úÖ |
| E13-S2 Google OAuth Backend | 8 | ‚úÖ |
| E13-S3 Google OAuth Frontend | 5 | ‚úÖ |
| E13-S4 Token Refresh | 3 | ‚úÖ |
| E13-S5 Microsoft OAuth | 3 | ‚úÖ |
| E13-S6 IMAP IDLE | 8 | ‚úÖ |
| E13-S7 Health Dashboard | 5 | ‚úÖ |
| **Total** | **37** | **‚úÖ** |

---

*Completed: 2025-12-29*
